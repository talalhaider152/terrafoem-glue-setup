name: Terraform Plan (prod)

on:
  pull_request:
    branches:
      - master
    paths:
      - "**/*.tf"

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  plan-prod:
    name: terraform plan (prod)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: .
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        run: terraform init -input=false



      - name: Terraform Validate
        run: terraform validate -no-color

      - name: Select workspace
        run: |
          terraform workspace select prod || terraform workspace new prod

      - name: Terraform Plan
        id: plan
        run: terraform plan -input=false -no-color -var-file="prod.tfvars" | tee plan.out

      - name: Comment plan on PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const planPath = path.join(process.cwd(), 'plan.out');
            const plan = fs.existsSync(planPath) ? fs.readFileSync(planPath, 'utf8') : 'No plan output found.';
            const maxLen = 65000;
            const truncated = plan.length > maxLen ? plan.substring(0, maxLen) + '\n\n[...truncated...]' : plan;
            const body = [
              'Terraform plan for env: prod',
              '',
              '```',
              truncated,
              '```'
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });


