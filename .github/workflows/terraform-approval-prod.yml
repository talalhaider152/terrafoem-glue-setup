name: Terraform Approval Handler (prod)

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write
  workflows: write

jobs:
  check-approval:
    name: Check approval and trigger apply
    runs-on: ubuntu-latest
    steps:
      - name: Check if approval is valid
        id: check_approval
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);
            const commentBody = context.payload.comment.body.toLowerCase();
            
            const hasApprovalLabel = labels.includes('approval-required');
            const hasProdLabel = labels.includes('prod');
            const hasApprovalKeyword = commentBody.includes('approved') || 
                                       commentBody.includes('lgtm') || 
                                       commentBody.includes('yes');
            
            const isValid = hasApprovalLabel && hasProdLabel && hasApprovalKeyword;
            
            core.setOutput('is_valid', isValid ? 'true' : 'false');
            
            if (!isValid) {
              console.log('Approval check failed:');
              console.log(`  - Has approval-required label: ${hasApprovalLabel}`);
              console.log(`  - Has prod label: ${hasProdLabel}`);
              console.log(`  - Has approval keyword: ${hasApprovalKeyword}`);
            }

      - name: Checkout
        if: steps.check_approval.outputs.is_valid == 'true'
        uses: actions/checkout@v4

      - name: Validate approver
        if: steps.check_approval.outputs.is_valid == 'true'
        id: validate_approver
        uses: actions/github-script@v7
        env:
          CODE_REVIEW: ${{ secrets.CODE_REVIEW }}
        with:
          script: |
            const commenter = context.payload.comment.user.login;
            const reviewers = process.env.CODE_REVIEW 
              ? process.env.CODE_REVIEW.split(',').map(u => u.trim()).filter(u => u)
              : [];
            
            if (reviewers.length === 0) {
              core.setOutput('is_valid', 'false');
              core.setOutput('message', 'No reviewers configured in CODE_REVIEW secret');
              return;
            }
            
            const isValid = reviewers.some(r => r.toLowerCase() === commenter.toLowerCase());
            core.setOutput('is_valid', isValid ? 'true' : 'false');
            core.setOutput('message', isValid 
              ? `Approved by @${commenter}` 
              : `@${commenter} is not in the approved reviewers list: ${reviewers.join(', ')}`);
            
            if (!isValid) {
              // Comment on issue that approval was rejected
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ùå **Approval Rejected**: ${core.getOutput('message')}`
              });
            }

      - name: Process approval
        if: steps.validate_approver.outputs.is_valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            const issueBody = context.payload.issue.body;
            const commenter = context.payload.comment.user.login;
            
            // Extract PR number from issue body
            const prMatch = issueBody.match(/\*\*PR\*\*: #(\d+)/);
            const branchMatch = issueBody.match(/\*\*Branch\*\*: (.+)/);
            
            if (!prMatch || !branchMatch) {
              console.error('Could not extract PR number or branch from issue body');
              return;
            }
            
            const prNumber = prMatch[1];
            const branch = branchMatch[1];
            
            // Update issue with approval status
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `‚úÖ **Approved by @${commenter}**\n\nüöÄ Triggering Terraform apply workflow...`
            });
            
            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'completed'
            });
            
            // Remove approval-required label
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'approval-required'
              });
            } catch (error) {
              console.warn(`Could not remove label: ${error.message}`);
            }
            
            // Add approved label
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['approved']
              });
            } catch (error) {
              console.warn(`Could not add label: ${error.message}`);
            }
            
            // Trigger the apply workflow
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'terraform-apply-prod.yml',
                ref: branch,
                inputs: {
                  approved: 'true',
                  issue_number: issueNumber.toString(),
                  pr_number: prNumber
                }
              });
              console.log(`Triggered apply workflow for branch ${branch}`);
            } catch (error) {
              console.error(`Failed to trigger workflow: ${error.message}`);
              // Comment on issue about the error
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `‚ùå **Error**: Failed to trigger apply workflow: ${error.message}`
              });
            }

