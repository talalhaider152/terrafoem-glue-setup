name: Terraform Apply (prod)

on:
  workflow_run:
    workflows: ["Terraform Plan (prod)"]
    types:
      - completed
    branches:
      - master
  workflow_dispatch:
    inputs:
      approved:
        description: "Approval status"
        required: false
        type: string
      issue_number:
        description: "Approval issue number"
        required: false
        type: string
      pr_number:
        description: "PR number"
        required: false
        type: string
  push:
    branches:
      - master
    paths:
      - "**/*.tf"

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  # This job runs on PR merge (push event) - no approval needed
  plan-and-apply-on-merge:
    name: terraform plan and apply (prod) - on merge
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    defaults:
      run:
        shell: bash
        working-directory: .
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        run: terraform init -input=false

      - name: Select workspace
        run: |
          terraform workspace select prod || terraform workspace new prod

      - name: Terraform Validate
        run: terraform validate -no-color

      - name: Terraform Plan
        run: terraform plan -input=false -no-color -var-file="prod.tfvars" | tee plan.out

      - name: Terraform Apply
        run: terraform apply -input=false -auto-approve -var-file="prod.tfvars"

  # This job runs after plan completes on PR - requires approval via issue
  apply-with-approval:
    name: terraform apply (prod) - requires approval
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.approved == 'true')
    defaults:
      run:
        shell: bash
        working-directory: .
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number && format('refs/pull/{0}/head', github.event.inputs.pr_number) || github.event.workflow_run.head_branch }}

      - name: Download plan artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          name: terraform-plan-prod
          path: .
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: terraform-plan-prod.yml
          run_id: ${{ github.event.workflow_run.id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        run: terraform init -input=false

      - name: Select workspace
        run: |
          terraform workspace select prod || terraform workspace new prod

      - name: Terraform Validate
        run: terraform validate -no-color

      - name: Terraform Plan
        run: terraform plan -input=false -no-color -var-file="prod.tfvars" | tee plan.out

      - name: Terraform Apply
        run: terraform apply -input=false -auto-approve -var-file="prod.tfvars"

      - name: Get PR number
        id: get_pr
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber = null;
            
            // If triggered via workflow_dispatch, use the provided PR number
            if (context.payload.inputs && context.payload.inputs.pr_number) {
              prNumber = context.payload.inputs.pr_number;
              core.setOutput('pr_number', prNumber);
              console.log(`Using PR number from workflow_dispatch: ${prNumber}`);
            } else if (context.payload.workflow_run) {
              // If triggered via workflow_run, find PR by branch
              const branch = context.payload.workflow_run.head_branch;
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${branch}`,
                state: 'all'
              });
              if (prs.data.length > 0) {
                prNumber = prs.data[0].number.toString();
                core.setOutput('pr_number', prNumber);
                console.log(`Found PR number from branch: ${prNumber}`);
              }
            }
            
            if (!prNumber) {
              console.warn('Could not determine PR number');
            }

      - name: Comment on PR
        if: steps.get_pr.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const planPath = path.join(process.cwd(), 'plan.out');
            const plan = fs.existsSync(planPath) ? fs.readFileSync(planPath, 'utf8') : 'No plan output found.';
            const maxLen = 65000;
            const truncated = plan.length > maxLen ? plan.substring(0, maxLen) + '\n\n[...truncated...]' : plan;
            const body = [
              '## âœ… Terraform Apply completed for prod environment',
              '',
              '```',
              truncated,
              '```'
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ steps.get_pr.outputs.pr_number }}'),
              body
            });


